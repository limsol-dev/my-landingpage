---
description: 
globs: 
alwaysApply: false
---
# ğŸŒ API & Data Management Excellence

## ğŸ“‹ CONTEXT & SCOPE
Korean pension booking system with Supabase backend, API routes, and Korean payment integration.
**CRITICAL**: All API patterns must handle Korean data formats and error messages.

## âœ… MUST DO - API Architecture Imperatives

### 1. API Route Structure (FOLLOW EXACTLY)
Reference [app/api/reservations/route.ts](mdc:app/api/reservations/route.ts):

```typescript
// âœ… MANDATORY: API route pattern
import { NextRequest, NextResponse } from 'next/server'
import { z } from 'zod'

// âœ… CRITICAL: Korean validation schema
const createReservationSchema = z.object({
  customerName: z.string().min(2, 'ì´ë¦„ì€ 2ê¸€ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤'),
  customerPhone: z.string().regex(/^010-\d{4}-\d{4}$/, 'ì˜¬ë°”ë¥¸ ì—°ë½ì²˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”'),
  checkIn: z.string().datetime('ì²´í¬ì¸ ë‚ ì§œë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”'),
  checkOut: z.string().datetime('ì²´í¬ì•„ì›ƒ ë‚ ì§œë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”'),
  totalGuests: z.number().min(1, 'ìµœì†Œ 1ëª… ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤')
})

// âœ… MANDATORY: API response type
interface APIResponse<T> {
  success: boolean
  data?: T
  error?: string
  koreanMessage?: string
  code?: string
}

export async function POST(request: NextRequest) {
  try {
    const body = await request.json()
    
    // âœ… MANDATORY: Validate with Zod
    const validatedData = createReservationSchema.parse(body)
    
    // Database operation here...
    const result = await createReservation(validatedData)
    
    // âœ… CRITICAL: Korean response format
    return NextResponse.json({
      success: true,
      data: result,
      koreanMessage: 'ì˜ˆì•½ì´ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤'
    } as APIResponse<ReservationInfo>)
    
  } catch (error) {
    // âœ… MANDATORY: Korean error handling
    if (error instanceof z.ZodError) {
      return NextResponse.json({
        success: false,
        error: 'VALIDATION_ERROR',
        koreanMessage: 'ì…ë ¥ ì •ë³´ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”',
        details: error.errors
      }, { status: 400 })
    }
    
    return NextResponse.json({
      success: false,
      error: 'INTERNAL_ERROR',
      koreanMessage: 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤'
    }, { status: 500 })
  }
}
```

### 2. Supabase Integration Pattern (REQUIRED)
```typescript
// âœ… MANDATORY: Supabase client setup with types
import { createClient } from '@supabase/supabase-js'
import type { Database } from '@/types/supabase'

const supabase = createClient<Database>(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.SUPABASE_SERVICE_ROLE_KEY!
)

// âœ… CRITICAL: Korean database operations with proper typing
export async function createReservation(data: ReservationFormData): Promise<ReservationInfo> {
  const { data: reservation, error } = await supabase
    .from('reservations')
    .insert({
      customer_name: data.customerName,
      customer_phone: data.customerPhone,
      check_in: data.checkIn.toISOString(),
      check_out: data.checkOut.toISOString(),
      total_guests: data.totalGuests,
      created_at: new Date().toISOString()
    })
    .select()
    .single()

  if (error) {
    throw new Error(`ì˜ˆì•½ ìƒì„± ì‹¤íŒ¨: ${error.message}`)
  }

  return reservation as ReservationInfo
}
```

### 3. Error Code Management (KOREAN-SPECIFIC)
```typescript
// âœ… CRITICAL: Korean error code system
export const KOREAN_ERROR_CODES = {
  VALIDATION_ERROR: 'ì…ë ¥ ì •ë³´ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤',
  DUPLICATE_BOOKING: 'ì´ë¯¸ ì˜ˆì•½ëœ ë‚ ì§œì…ë‹ˆë‹¤',
  FULLY_BOOKED: 'ì˜ˆì•½ì´ ë§ˆê°ë˜ì—ˆìŠµë‹ˆë‹¤',
  INVALID_PHONE: 'ì—°ë½ì²˜ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤',
  INVALID_DATE: 'ë‚ ì§œê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤',
  PAYMENT_FAILED: 'ê²°ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤',
  UNAUTHORIZED: 'ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤',
  FORBIDDEN: 'ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤',
  INTERNAL_ERROR: 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤'
} as const

export type KoreanErrorCode = keyof typeof KOREAN_ERROR_CODES

export function createErrorResponse(
  code: KoreanErrorCode,
  details?: unknown
): APIResponse<never> {
  return {
    success: false,
    error: code,
    koreanMessage: KOREAN_ERROR_CODES[code],
    ...(details && { details })
  }
}
```

## âŒ NEVER DO - API Anti-Patterns

### ğŸš« FORBIDDEN API Patterns
```typescript
// âŒ NEVER: Unvalidated API input
export async function POST(request: NextRequest) {
  const body = await request.json()
  // Direct use without validation - DANGEROUS
  const result = await createReservation(body)
}

// âŒ NEVER: Generic error responses
return NextResponse.json({ error: 'Something went wrong' })

// âŒ NEVER: Expose internal errors
catch (error) {
  return NextResponse.json({ error: error.stack })  // Security risk
}

// âŒ NEVER: Untyped database operations
const { data } = await supabase.from('reservations').select()  // No typing
```

### ğŸš« FORBIDDEN Type Patterns
```typescript
// âŒ NEVER: any type for API responses
const response: any = await fetch('/api/reservations')

// âŒ NEVER: Missing error handling
const data = await response.json()  // No try/catch

// âŒ NEVER: Hardcoded Korean messages in types
type ErrorMessage = 'ì˜ˆì•½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤'  // Use constants
```

---

## ğŸ¯ API CHECKLIST
Before deploying any API:
- [ ] Input validation with Zod
- [ ] Korean error messages with proper codes
- [ ] Proper HTTP status codes
- [ ] Type-safe database operations  
- [ ] Error logging for debugging
- [ ] Response type interfaces
- [ ] Korean localization support


